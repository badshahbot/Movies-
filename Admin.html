<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>एडमिन पैनल - मूवीज़ मैनेज करें</title>
    <style>
        :root { --primary: #00BFFF; --secondary: #222; --background: #141414; --text-primary: #fff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--background); color: var(--text-primary); }
        .view { display: none; padding: 20px; padding-bottom: 100px; }
        .view.active { display: block; }
        .container { max-width: 1200px; margin: auto; }
        
        button { cursor: pointer; transition: transform 0.1s ease; }
        button:active { transform: scale(0.96); }

        .btn-primary { background-color: var(--primary); color: var(--text-primary); width: 100%; padding: 12px 20px; border: none; border-radius: 4px; font-weight: bold; font-size: 16px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        header h1 { font-size: 28px; color: var(--primary); }
        
        .search-container { margin-bottom: 20px; }
        #movieSearchInput { width: 100%; padding: 12px; border-radius: 4px; border: 1px solid #444; background-color: #333; color: var(--text-primary); font-size: 16px; }
        
        #movie-stats { font-size: 18px; color: #ccc; margin-bottom: 20px; }
        .list-section { background-color: var(--secondary); padding: 20px; border-radius: 8px; }
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 4px; }
        .list-item:nth-child(even) { background-color: #2a2a2a; }
        .list-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70%; font-size: 16px; }
        .btn-edit { background-color: #444; color: var(--text-primary); border: none; padding: 8px 15px; font-size: 14px; border-radius: 4px; }

        .fab { width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary); color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.4); position: fixed; bottom: 30px; right: 30px; z-index: 501; border: none; }
        
        #form-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background); z-index: 1500; overflow-y: auto; }
        .form-container { padding: 20px; padding-bottom: 80px; }
        .form-header { display: flex; align-items: center; margin-bottom: 20px; }
        .btn-back { font-size: 28px; background: none; border: none; color: var(--text-primary); padding-right: 15px; }
        #form-title { font-size: 24px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border-radius: 4px; border: 1px solid #444; background-color: #333; color: var(--text-primary); font-size: 16px; }
        .form-group textarea { resize: vertical; min-height: 100px; }

        #toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.4s, visibility 0.4s, bottom 0.4s; font-size: 14px; font-weight: 500; border: 1px solid var(--primary); }
        #toast-notification.show { opacity: 1; visibility: visible; bottom: 40px; }
    </style>
</head>
<body>

    <!-- Home View: Shows movie list and search bar -->
    <div id="home-view" class="view active">
        <div class="container">
            <header><h1>Movie Admin</h1></header>
            <div class="search-container">
                <input type="text" id="movieSearchInput" onkeyup="filterMovies()" placeholder="Search for movies to edit...">
            </div>
            <div id="movie-stats">Loading...</div>
            <div class="list-section">
                <div id="movies-list"></div>
            </div>
        </div>
        <button class="fab" onclick="openForm('add')">+</button>
    </div>

    <!-- Form View: For adding or editing a movie -->
    <div id="form-view" class="view">
        <div class="form-container container">
            <div class="form-header">
                <button class="btn-back" onclick="switchView('home-view')">&lt;</button>
                <h2 id="form-title"></h2>
            </div>
            <form id="movie-form">
                <input type="hidden" id="docId">
                <div class="form-group"><label for="title">Title</label><input type="text" id="title" required></div>
                <div class="form-group"><label for="imageUrl">Image URL</label><input type="url" id="imageUrl" required></div>
                <div class="form-group"><label for="description">Description</label><textarea id="description"></textarea></div>
                <div class="form-group"><label for="language">Language</label><input type="text" id="language"></div>
                <div class="form-group"><label for="telegramLink">Telegram Channel Link</label><input type="url" id="telegramLink"></div>
                <button type="submit" class="btn-primary" style="margin-top: 20px;">Save Movie</button>
            </form>
        </div>
    </div>
    
    <div id="toast-notification"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // --- NEW FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyBzNXcgWZEwn6B2sPJJzdRBasNXaNyb4Bs",
          authDomain: "myweb-5c13a.firebaseapp.com",
          databaseURL: "https://myweb-5c13a-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "myweb-5c13a",
          storageBucket: "myweb-5c13a.firebasestorage.app",
          messagingSenderId: "566157637233",
          appId: "1:566157637233:web:4511f16ab80d4f32620dd0",
          measurementId: "G-N0W3F2EZVB"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const movieForm = document.getElementById('movie-form');
        let allMoviesData = []; // To store all movies locally for searching

        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 2500);
        }

        // Renders the list of movies on the home page
        function renderMovieList(moviesToRender) {
            const listEl = document.getElementById('movies-list');
            if (moviesToRender.length === 0) {
                listEl.innerHTML = `<p>No movies found.</p>`;
                return;
            }
            listEl.innerHTML = moviesToRender.map(movie => {
                return `<div class="list-item">
                            <span>${movie.title}</span>
                            <button class="btn-edit" onclick="openForm('edit', '${movie.id}')">Edit</button>
                        </div>`;
            }).join('');
        }

        // Fetches all movies from Firestore
        async function fetchMovies() {
            try {
                const snapshot = await db.collection('movies').orderBy("timestamp", "desc").get();
                allMoviesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                document.getElementById('movie-stats').innerText = `Total Movies: ${allMoviesData.length}`;
                renderMovieList(allMoviesData);
            } catch (err) {
                console.error("Error fetching movies:", err);
                document.getElementById('movie-stats').innerText = 'Could not load movies.';
                alert("Error fetching data. Make sure your Firestore rules allow reading.");
            }
        }

        // Filters movies based on search input
        function filterMovies() {
            const filter = document.getElementById('movieSearchInput').value.toLowerCase();
            const filteredMovies = allMoviesData.filter(movie => movie.title.toLowerCase().includes(filter));
            renderMovieList(filteredMovies);
        }

        // Opens the form for adding or editing
        async function openForm(mode, docId = null) {
            movieForm.reset();
            document.getElementById('docId').value = docId;

            if (mode === 'add') {
                document.getElementById('form-title').innerText = 'Add New Movie';
            } else {
                document.getElementById('form-title').innerText = 'Edit Movie';
                try {
                    const doc = await db.collection('movies').doc(docId).get();
                    if (doc.exists) {
                        const movie = doc.data();
                        document.getElementById('title').value = movie.title || '';
                        document.getElementById('imageUrl').value = movie.imageUrl || '';
                        document.getElementById('description').value = movie.description || '';
                        document.getElementById('language').value = movie.language || '';
                        document.getElementById('telegramLink').value = movie.telegramLink || '';
                    } else {
                        alert("Movie not found!");
                        return;
                    }
                } catch (err) {
                    alert("Error fetching movie details.");
                    console.error(err);
                    return;
                }
            }
            switchView('form-view');
        }

        // Handles form submission
        movieForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('docId').value;
            
            const data = {
                title: document.getElementById('title').value,
                imageUrl: document.getElementById('imageUrl').value,
                description: document.getElementById('description').value,
                language: document.getElementById('language').value,
                telegramLink: document.getElementById('telegramLink').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (docId) { // Editing existing document
                    await db.collection('movies').doc(docId).set(data, { merge: true });
                    showToast('Movie updated successfully!');
                } else { // Adding new document
                    await db.collection('movies').add(data);
                    showToast('Movie added successfully!');
                }
                switchView('home-view');
                fetchMovies(); // Refresh the movie list
            } catch (err) {
                console.error("Error saving movie:", err);
                alert("Error saving data. Make sure your Firestore rules allow writing.");
            }
        });
        
        // Make functions globally accessible for onclick attributes
        window.switchView = switchView;
        window.openForm = openForm;
        window.filterMovies = filterMovies;

        // Initial fetch of data when the page loads
        fetchMovies();
    </script>
</body>
</html>